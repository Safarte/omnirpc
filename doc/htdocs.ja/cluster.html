<HTML>
<HEAD>
<TITLE> OmniRPC: run on Cluster </TITLE>
</HEAD>
<BODY bgcolor="#fffff0">

<h2> クラスタでの実行 </h2>

<p>
多くのPCやワークステーションをネットワークで結合したクラスタはグリッド
環境において、代表的な計算資源です。
OmniRpcでは、クラスタをひとまとまりにしてリモートホストとして扱うこと
ができます。クラスタの各ノードにおいて、リモート実行モジュールを実行さ
せ、並列実行することにより高速化することができます。
</p>
<dl>
<dt> <a href=#1> クラスタ環境の設定 </a> </dt>
<dt> <a href=#2> ジョブスケジューラの選択 </a> </dt>
<dt> <a href=#3> 内蔵ラウンドロビンスケジューラの利用 </dt>
<dt> <a href=#4> ローカルアドレスを使ったクラスタの場合 </a> </dt>
<dt> <a href=#5> ファイヤウォール内にあるクラスタの場合 </a> </dt>
</dl>


<!-- ----------------------------- -->
<hr>
<h3> <a name=1> クラスタ環境の設定 </a> </h3>
<p>
クラスタを利用する場合には、クラスタ内の最低１つの計算機がクライアント
ホストからアクセス可能でなくてはなりません。この計算機のことを、
<em> クラスタサーバホスト</em>と呼ぶことにします。クラスタホスト以外の
クラスタ内の計算機を<em>クラスタノードホスト</em>と呼ぶことにします。
</p>

以下の説明では、以下のような環境を仮定します。

<ol>
<li> クライアントホストは、jones.tsukuba.ac.jp
<li> クラスタサーバホストは、hpc-serv.hpcc.jpとし、各クラスタ
ノードホストとして、hpc1, hpc2, hpc3の3つの計算機が接続されてい
る。
<li> クラスタサーバーホストと各クラスタノードは同じファイルシステムを
共有している。
<li> クラスタサーバホストと全てのクラスタノードはクライアントホストへ
直接ネットワーク接続でき、全てのポートはopenされている。
</ol>

<p>
最後の条件は、例えば、同じネットワークにクライアント、クラスタがある場
合です。
</p>

<h3> <a name=2> ジョブスケジューラの選択 </a> </h3>
<p>
OmniRpcでは、まず、Agentをクラスタサーバホストに起動し、このAgentが適
当な<em>スケジューラ</em>をつかってクラスタノードホストで、リモート実
行モジュールを実行します。スケジューラとして以下のものを指定することが
できます。
<ul>
<li> 内蔵ラウンドロビンスケジューラ (rr)
<li> Portable Batch System (PBS) <font color=red> (未実装)</font>
<li> SunGridEngine (SGE) <font color=red> (未実装)</font>
</ul>
</p>

<h3> <a name=3> 内蔵ラウンドロビンスケジューラの利用 </h3>

<p>
内蔵ラウンドロビンスケジューラは、Agent内に実装されている簡単なスケジュー
ラです。クラスタノードホストに順番にリモート実行モジュールを実行するた
めのジョブを起動するためのスケジューラです。
</p>
<p>
このスケジューラを使うためには、まず、クラスタノードホストを指定するファ
イルnodesをクラスタサーバホストのレジストリ(~/.omrpc-registry)に作りま
す。例の設定の場合は以下のようになります。
</p>
<pre>
hpc1
hpc2
hpc3
</pre>
<p>
クライアントホストでは以下のようなホストファイルを作ります。
<pre>
&lt;?xml version="1.0" ?&gt;
&lt;OmniRpcConfig&gt;
   &lt;Host name="hpc-serv.hpcc.jp" arch="i386" os="linux"&gt;
   <font color=red>&lt;JobScheduler type="rr" maxjob="4" /&gt;</font> 
   &lt;/Host&gt;
&lt;/OmniRpcConfig&gt;
</pre>
JobScheduler要素のtype属性にラウンドロビンスケジューラ"rr"を設定します。
ちなみに、このtype属性のdefalutは"fork"で単に、同じホスト内でプロセス
を実行することを意味します。これは、SMPの利用の所での設定です。
また、ノードホストの数は4ですので、最大のジョブ数maxjobを4に設定してい
ます。
</p>
<p>
この指定でのagentとrexの関係は以下のようになります。
</p>
<img src="fig6.gif">

<h3> <a name=4> ローカルアドレスを使ったクラスタの場合 </a> </h3>

<p>
上の例ではクライアントホストとクラスタのホストが、同じネットワーク上に
ある例について説明しましたが、クラスタノードホスト上で実行されるリモー
ト実行プログラムはクライアントホストに対して直接通信します。クラスタと
クライアントホストが異なるネットワーク上にある場合でも、クラスタノード
ホストからクライアントホストに対して通信できることが必要です。
</p>

<p>
しかし、クラスタはその
ノードホストが多くなるとローカルなIPアドレスを使って構成されることが多
くなります。この場合、サーバホストだけがグローバルなIPアドレスを持ち、
ノードホストはローカルなIPアドレスで構成されます。OmniRpcでは、クラス
タノードホストがクライアントホストと通信する必要がありますが、
この場合には、クラス
タノードホストと外部にあるクライアントホストは直接接続できません。
</p>
<p>
このような
クラスタを利用するには２つの方法があります。
<ol>
<li> クラスタノードホストから外部のネットワークに接続するためにNATを設
定する。各クラスタノードからクライアントノードの任意のポートに接続でき
るように設定しなくてはなりません。NATの設定についてはその関連の資料を
参照してください。
<li> Agentの通信の多重化機能を利用して、クラスタノードホストで実行され
るリモート実行プログラムとクライアントホストの通信を中継する。
</ol>
</p>
<p>
後者の場合のホストファイルの例を示します。
<pre>
&lt;?xml version="1.0" ?&gt;
&lt;OmniRpcConfig&gt;
   &lt;Host name="hpc-serv.hpcc.jp" arch="i386" os="linux"&gt;
   &lt;Agent invoker="rsh" mxio="on" /&gt;
   &lt;JobScheduler type="rr" maxjob="4" /&gt;
   &lt;/Host&gt;
&lt;/OmniRpcConfig&gt;
</pre>
Agent要素のmxio属性を"on"指定します。この例では、クラスタサーバーホス
トとクライアントホストが同じネットワークにあるものとして、"rsh"を指定
していますが、SSHを用いてAgentを起動する場合には"ssh"、Globus Gate
Keeperを使って起動する場合には"globus"とします。
</p>
<p>
この指定でのagentとrexの関係は以下のようになります。
</p>
<img src="fig8.gif">
<p>
クライアントとリモートノードホストで実行されるrexとの通信は、agentを介
して行われます。
</p>

<h3> <a name=5> ファイヤウォール内にあるクラスタの場合 </a> </h3>
<p>
ファイヤウォール内にクラスタを外部から利用する場合について説明します。
ファイヤウォールが設定されている場合、少なくともクラスタサーバホストに
対してはsshを使ってアクセスできることが必要です。sshが用いるポート22以
外のポートが利用できない場合には、Agentによる通信多重化機能を使うこと
によって、利用できます。以下に、この設定についてのホストファイルの例を
しめします。
<pre>
&lt;?xml version="1.0" ?&gt;
&lt;OmniRpcConfig&gt;
   &lt;Host name="hpc-serv.hpcc.jp" arch="i386" os="linux"&gt;
   &lt;Agent invoker="ssh" mxio="on" /&gt;
   &lt;JobScheduler type="rr" maxjob="4" /&gt;
   &lt;/Host&gt;
&lt;/OmniRpcConfig&gt;
</pre>
Agent要素のmxio属性を"on"指定し、通信多重化機能を使います。
</p>

<p>
Globusを用いる環境では、通常、ファイヤウォールは設定されていないため、
このような設定は必要ありませんが、前の部分で説明したとおり、クラスタノー
ドがプライベートIPアドレスの場合には、同じように、mxio属性をセットしな
くてはなりません。
</p>
<p>
この指定でのagentとrexの関係は以下のようになります。
</p>
<img src="fig7.gif">
<p>
クライアントとリモートノードホストで実行されるrexとの通信は、agentを介
して行われますが、agentとクライアントはport forwardingを使って、
firewallを通過して行われます。
</p>

<hr>
</BODY>
</HTML>








